<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
-->

<!-- <script src="../auth/auth.js"></script> -->

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="my-profile">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }
            .personal{width: 49%; display: inline-block; margin-bottom: 20px;}
            .personal[mobile-layout] {width: 100%; margin-bottom: 0px;}
            .location{width: 49%; display: inline-block; float: right; margin-bottom: 20px;}
            .location[mobile-layout] {width: 100%;}
            .spacer{display: block; height: 15px;}
            paper-button{width: 100%; color: #FFF;}
        </style>

        <firebase-auth id="auth" user="{{person}}" on-error="handleError" status-known="{{statusKnown}}"></firebase-auth>
        <iron-location id="ironLocation"></iron-location>
        
        <div class="card">
            <div class="error" hidden$="[[!message]]">[[message]]</div>
            <form is="iron-form" id="form">
                <div class="personal"  mobile-layout$="[[isMobilePhone]]">
                    <h2>Algemeen</h2>
                    <paper-input value="{{custom.voornaam}}" type="text" id="voornaam" placeholder="Voornaam" autoValidate="true" required error-message="needs some text!"></paper-input>
                    <paper-input value="{{custom.achternaam}}" type="text" id="achternaam" placeholder="Achternaam" required error-message="needs some text!"></paper-input>
                    <div class="spacer"></div>
                    <label>Geslacht:</label><br>
                    <paper-radio-group selected="{{custom.geslacht}}" id="geslacht" fallback-selection="O" required>
                        <paper-radio-button name="M">Man</paper-radio-button>
                        <paper-radio-button name="V">Vrouw</paper-radio-button>
                        <paper-radio-button name="O">Overig</paper-radio-button>
                    </paper-radio-group>
                    <paper-input value="{{ custom.gbdatum }}"  pattern="\d{4}-\d{1,2}-\d{1,2}" id="gbdatum" required error-message="needs some text!" type="text" placeholder="Geboortedatum (yyyy-mm-dd)"></paper-input>
                </div>

                <div class="location" mobile-layout$="[[isMobilePhone]]">
                    <h2>Verblijf</h2>
                    <paper-input value="{{custom.woonplaats}}" type="text" id="woonplaats" required error-message="needs some text!" placeholder="Woonplaats"></paper-input>

                    <div class="spacer"></div>

                    <paper-checkbox name="hospital" id="reval-chk" on-click="showHospital">Ziekenhuis</paper-checkbox>
                    <paper-checkbox name="revalidation" id="reval-chk" on-click="showRevalidation">Revalidatiecentrum</paper-checkbox>
                    <paper-checkbox name="home">Thuis</paper-checkbox>
                    <div id="autoUpdate" class="autoUpdate" hidden$="{{hospital}}">
                        <paper-dropdown-menu label="Ziekenhuizen">
                            <paper-listbox class="dropdown-content">
                                <paper-item>UMCU</paper-item>
                                <paper-item>AMC</paper-item>
                                <paper-item>LMC</paper-item>
                                <paper-item>Mart</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </div>
                    <div id="autoUpdate" class="autoUpdate" hidden$="{{revalidation}}">
                        <paper-dropdown-menu label="Revalidatiecentrum">
                            <paper-listbox class="dropdown-content">
                                <paper-item>De Hoogstraat</paper-item>
                                <paper-item>Gomez</paper-item>
                                <paper-item>Zusje</paper-item>
                                <paper-item>Mart</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </div>
                </div>

                <div>{{custom.status}}</div>
                <paper-button raised on-tap="addProfile">Volgende stap</paper-button>
            </form>
            <iron-media-query query="(max-width:768px)" query-matches="{{isMobilePhone}}"></iron-media-query>

        </div>

        <iron-ajax
                   id="addProfile"
                   method="POST"
                   url="https://api.tys-chat.nl/persoon"
                   handle-as="json"
                    headers='{"Content-Type": "application/json;charset=utf-8"}' 
                   content-type="application/json"
                   on-response="handleResponse">
        </iron-ajax>
        <iron-meta-query key="token" id="meta" value="{{idToken}}"></iron-meta-query>
    </template>    

    <script>
        Polymer({
            is: 'my-profile',
            properties: {
                message: {
                    type: String,
                    value: '',
                },
                hospital: {
                    type: Boolean,
                    value: true,
                },
                revalidation: {
                    type:Boolean,
                    value: true,
                },
                idToken: {
                    type: String,
                },
                custom:{
                    type: Object,
                },
                jsonUser: {
                    type: String,
                }
            },
              listeners: {
                'iron-form-submit': '_handleSubmit'
              },
            handleError: function(e) {
                this.message = 'Error: ' + e.detail.message;
            },
            validateFields: function(){
                console.log(this.$.geslacht.selected);
                if(this.$.form.validate()){
                    return true;
                }
               
            },
            showHospital: function(){
                console.log(this.custom.voornaam);
                this.hospital = !this.hospital
            },
            showRevalidation: function() {
                this.revalidation = !this.revalidation
            },
            handleResponse: function(e) {
                if(e.detail.xhr.status == 200){
                    this.$.ironLocation.set('path', '/preferences');
                }
            },
            addProfile: function(e){
                if(this.idToken != undefined && this.validateFields()){
                    this.$.addProfile.headers['authorization'] = this.idToken;
                    console.log(JSON.stringify(this.custom));
                    this.custom.status = 2;
                    this.$.addProfile.body = JSON.stringify(this.custom);
                    this.$.addProfile.generateRequest();
                }
            }
        });
    </script>
</dom-module>